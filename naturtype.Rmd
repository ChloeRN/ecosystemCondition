# (PART\*) GENERAL TOPICS {.unnumbered}

# On the application of the naturetype dataset {#naturtype}

<br />

```{r, include=FALSE}
library(knitr)
library(sf)
library(tmap)
library(ggplot2)
library(data.table)
library(stringr)
library(units)
library(dplyr)
knitr::opts_chunk$set(echo = TRUE)
```

*Work in progress*

Author: Anders L. Kolstad

Date: `r Sys.Date()`

Here I will investigate a specific data set, [Naturtyper - Miljødirektoratets instruks](https://kartkatalog.geonorge.no/metadata/naturtyper-miljoedirektoratets-instruks/eb48dd19-03da-41e1-afd9-7ebc3079265c) and try to evaluate its usability for designing indicators for ecosystem condition. This involves assessing both the spatial and temporal representativity, as well as conseptual alignment with the [Norwegian system for ecosystem condition assessments](https://www.regjeringen.no/no/dokumenter/fagsystem-for-fastsetting-av-god-okologisk-tilstand/id2558481/).

The precision in field mapping will not be assess in itself. We assume some, or even considerable, sampling error, but this is inherent to all field data.

## Import data and general summary statistics

```{r}
# local path
#path <- "data/R:/GeoSpatialData/Habitats_biotopes/Norway_Miljodirektoratet_Naturtyper_nin/Original/Natur_Naturtyper_NiN_norge_med_svalbard_25833.gdb"

# server path
#path <- "/data/P-Prosjekter/41201785_okologisk_tilstand_2022_2023/data/Natur_Naturtyper_NiN_norge_med_svalbard_25833.gdb"

# temporary path 
path <- "/data/Egenutvikling/41001581_egenutvikling_anders_kolstad/data/Natur_Naturtyper_NiN_norge_med_svalbard_25833.gdb"


dat <- sf::st_read(dsn = path)
names(dat)
```

Fix non-valid polygons

```{r}
dat <- sf::st_make_valid(dat)
```

Import outline of Norway

```{r}
nor <- sf::read_sf("data/outlineOfNorway_EPSG25833.shp")
```

The dataset has 95k polygons, each with 36 variables:

```{r}
dim(dat)
```

It therefore takes a little minute to render a plot, but this is the code to do it:

```{r, eval = F}
tmap_mode("view")
tm_shape(dat) + 
  tm_polygons(col="tilstand")+
  tm_shape(nor)+
  tm_polygons(alpha = 0,border.col = "black")
```

### Area

Calculating the area

```{r}
dat$area <- sf::st_area(dat)
summary(dat$area)
```

The smallest polygons are 20 m2, and the biggest is 8.5 km2.

Sum of mapped area divided by Norwegian mainland area

```{r}
sum(dat$area)/sf::st_area(nor)
```

About 0.5% has been mapped. It is therefore essential that these 0.5% are representative (of the remaining 99.5%).

### Temporal trend

```{r}
dat$kartleggingsår <- as.numeric(dat$kartleggingsår)
```

```{r}
area_year <- as.data.frame(tapply(dat$area, dat$kartleggingsår, sum))
names(area_year) <- "area"
area_year$year <- row.names(area_year)
area_year$area_km2 <- area_year$area/10^6
```

```{r area_year, fig.cap="Temproal trend in nature type mapping using Miljødirektoratets Instruks"}
ggplot(area_year)+
  geom_bar(aes(x = year, y = area_km2),
           stat = "identity",
           fill = "grey",
           colour="black",
           size = 2)+
  theme_bw(base_size = 12)+
  labs(x = "Year", y = "Total mapped area (km/2)")
```

The rate of nature type mapping is strongly positive last three years. There are some differences in the field mapping instructoin between the years. I will need to decide whether to include all years, or to perhaps exclude the first year.


### Condition

A quick overview of the conditions 

```{r tilstand_overview, fig.cap="The overal distribution of condition scores"}
barplot(tapply(dat$area/10^6, factor(dat$tilstand), sum))
```

Most sites/polygons are in either good or moderately good condition. I'm not sure what thet first class represents. It seems like som polygons dont have a condition score. Looking at just the dataset, and also the online *faktaark* for some of these localities, does not give the answer.

```{r, eval=F}
View(dat[dat$tilstand=="",])
```

This figure also show that these cases are not restricted to just one field season.
```{r}
barplot(table(dat$kartleggingsår[dat$tilstand==""]), 
        ylab="Number of localities without condition scores",
        xlab="Year")
```

```{r}
par(mar=c(5,20,1,1))
barplot(table(dat$hovedøkosystem[dat$tilstand==""]),
        horiz = T, las=2,
        xlab="Number of localities without condition scores")

```

These cases are restricted to two main ecosystems, and one class where the main ecosystem is not recorded. Look at some of those cases it is clear that they are not relevant for our work here, I and I dont know why they are in the data set to begin with.

```{r}
dat <- dat[dat$hovedøkosystem!="Ingen",]
```

```{r}
par(mar=c(5,20,1,1))
barplot(table(dat$naturtype[dat$tilstand==""]),
        horiz = T, las=2,
        xlab="Number of localities without condition scores")

```

After excluding those without a main ecosystem, there are only six nature types left that don't have a condition score.

Snøleieblokkmark and rabbeblokkmark are not assessed for condition status. Leirskredgrop,,leirravine and grotte were nature types in 2018 (not mapped in 2021), and was not assessed for condition scores. Isinnfrysingsmark is assessed for condition now, but not in 2018. We can therefore exclude these localities from our data set.

```{r}
dat <- dat[dat$tilstand!="",]
```

### Mosaic types

The field mapping instruction include and option for delineating mosaic types. Let's investigate these cases.
When an area displays a repeating pattern of mixed nature types that each are smaller than the minimum mapping unit MMU, these are grouped into as many overlapping polygons as there are uniqe nature types. Within the nature type polyogons, these will have the same distribution of NiN-grunntyper (online you can see the percentage distribution, but our data set only has the presence/absence data) but be assigned different nature types (nature types is the Environmental agencies classification). The condition scoring can be unique to each overlapping nature type in the mosaic. But we don't know the precise location of the NiN-grunntyper that are part of mosaic nature types.

```{r}
barplot(table(dat$mosaikk),
        xlab = "Mosaic", ylab="Number of localities")
```

```{r}
mos <- dat[dat$mosaikk=="Ja",]
```

```{r}
par(mar=c(5,20,1,1))
barplot(table(mos$hovedøkosystem),
        horiz = T, las=2,
        xlab="Number of mosaic localities")
```

Mosaic localities occur in many main ecosystems (and many nature types therein). 

Some conclusion here could be that

1. Mosaic localities cannot be used to pin-point NiN grunntyper. 
1. Mosaic localities can be used to extract condition scores for nature types, but these should not be ties to all the NiN grunntype listed in that polygon, because that will include some that belong to the other part of the mosaic.

### NiN types across main ecosystems

The NiN-types can be extracted from the column `ninkartleggingsenheter`, but it is oddly concatenated. Let's tease it apart.

```{r}
dat$ninkartleggingsenheter2 <- gsub("NA_", dat$ninkartleggingsenheter, replacement = "")
dat$ninkartleggingsenheter2 <- str_replace_all(dat$ninkartleggingsenheter2, ".[CE].[\\d]{1,}", replacement = "")
dat$ninkartleggingsenheter2 <- str_replace_all(dat$ninkartleggingsenheter2, "-.", replacement = "")
uni <- function(x){paste(unique(unlist(strsplit(x, ","))), collapse = ",")}
dat$ninkartleggingsenheter3 <- lapply(dat$ninkartleggingsenheter2, uni)
n_uni <- function(x){length(unique(unlist(strsplit(x, ","))))}
dat$n_ninkartleggingsenheter <- lapply(dat$ninkartleggingsenheter2, n_uni)
dat$n_ninkartleggingsenheter <- as.numeric(dat$n_ninkartleggingsenheter) 

par(mfrow=c(1,3))
barplot(table(dat$n_ninkartleggingsenheter),
        xlab = "Number of NiN main types",
        ylab = "Number of localities")
barplot(table(dat$n_ninkartleggingsenheter[dat$mosaikk=="Nei"]),
        xlab = "Number of NiN main types\n(Mosaic localities excluded)")
barplot(table(dat$n_ninkartleggingsenheter[dat$mosaikk=="Ja"]),
        xlab = "Number of NiN main types\n(Mosaic localities only)")

```

Mosaic localities have a much higher likelihood of including multiple NiN main types, but it also occurs in non-mosaic localities (about 8000), so we need to see whats going on there.


```{r}
dat_melt <- tidyr::separate_rows(dat, ninkartleggingsenheter3)
```

```{r}
ggplot(dat_melt[dat_melt$mosaikk!="Ja",])+
  geom_bar(aes(x = ninkartleggingsenheter3))+
  coord_flip()+
  theme_bw(base_size = 12)+
  facet_wrap("hovedøkosystem",
             scales = "free")

```

There is a lot of miss-match between NiN main types and 'hovedøkosystem'. 
Taking one example. T2 (åpne grunnledt mark) is not found in mountains, but there is one case where this occurs. If I view that case

```{r, eval= FALSE}
View(dat_melt[dat_melt$mosaikk!="Ja" & dat_melt$hovedøkosystem=="Fjell" & dat_melt$ninkartleggingsenheter3=="T2",])
```

.. and find the online fact sheet for that locality, I see that it is indeed not a mosaic. It is a nature type called *Kalkfattig og intermediær fjellhei, leside og tundra* which is defined as strictly T3, but the field surveyor has recorded lots of main nature types. This is a mistake. Online I can see that the locality is 50% T3, but this information is not in the data set that we have available. And the order of the NiN types in the `ninkartleggingsenhete` column is not reflecting the commonness of the types ether. 

If there was a way to extract the defining NiN type from the `naturtype` column, that would be nice. If we exclude all localities that are not mosaics, but that have multiple NiN main types, we fisr need to know if there are not any `naturtype` which allow for multiple NiN main types.

As this next figure show, these cases are not correlated to mapping year, and hence to any changes in the field protocol.
```{r}
temp <- dat[dat$n_ninkartleggingsenheter>1 & dat$mosaikk!="Ja",]
barplot(table(temp$kartleggingsår), ylab="Number of localities ")
```

```{r}
temp2 <- as.data.frame(table(temp$naturtype, temp$n_ninkartleggingsenheter))
temp2 <- temp2[base::order(temp2$Freq, decreasing = T),][1:10,]
par(mar=c(8,20,1,1))
barplot(temp2$Freq, names.arg = temp2$Var1, las=2,
        horiz = T, xlab = "Number of localities with >1 NiN main type")
```

'Hule eiker' is a special case because these are recorded as points and not polygons, and they can be found in any NiN main type and any *hovedøkosystem*. 

```{r}
dat[dat$naturtype=="Hule eiker",][1:5,c("naturtype", "hovedøkosystem", "ninkartleggingsenheter")]
```

*Kystlynghei* often occurs as a moisaic, but the figure above has excluded the mosaic localities, and then *kystlynghei* is stricktly defined to T34.
```{r}
dat[dat$naturtype=="Kystlynghei",][1:5,c("naturtype", "hovedøkosystem", "ninkartleggingsenheter")]

```

The same is true for *naturbeitemark* which is restricted to T32.

Maybe these should all have been recorded as mosaic localities. In any case, we cannot automatically extract the main NiN type from these rows. One option is to manually define all *naturbeitemark* as T32, and all *kystlynghei* as T34, etc.

Lets look at how the NiN main types cover the different *hovedøkosystem* when we exclude *Hule eiker* and all localities that have more than one NiN main type.

```{r}
dat_red <- dat_melt[dat_melt$n_ninkartleggingsenheter==1 & dat_melt$naturtype != "Hule eiker",]
```

```{r}
  ggplot(dat_red)+
  geom_bar(aes(x = ninkartleggingsenheter3),
           fill="grey",
           colour="black")+
  coord_flip()+
  theme_bw(base_size = 12)+
  facet_wrap("hovedøkosystem",
             scales = "free")+
  labs(y = "Number of localities",
       x = "NiN main types")

```


A reduced version just looking at the three target main ecosystems:
```{r}
target <- c("Semi-naturlig mark",
            "Våtmark",
            "Naturlig åpne områder under skoggrensa")
```


```{r}
  ggplot(dat_red[dat_red$hovedøkosystem %in% target,])+
  geom_bar(aes(x = ninkartleggingsenheter3),
           fill="grey",
           colour="black")+
  coord_flip()+
  theme_bw(base_size = 12)+
  facet_wrap("hovedøkosystem",
             scales = "free",
             ncol = 3)+
  labs(y = "Number of localities",
       x = "NiN main types")

```

Still some weird cases...

```{r}
dat_red_ordered <- dat_red[base::order(dat_red$ninkartleggingsenheter3),] %>%
  dplyr::mutate(ninkartleggingsenheter_f=
                  factor(dat_red_ordered$ninkartleggingsenheter3, 
                      levels(dat_red_ordered$ninkartleggingsenheter3)))

```

```{r}
ggplot(dat_red)+
  geom_bar(aes(x = ninkartleggingsenheter3),
           fill="grey",
           colour="black")+
  coord_flip()+
  theme_bw(base_size = 12)+
  facet_wrap("hovedøkosystem",
             scales = "free")

```


## Overview of nature types

-   What are the dominant ecosystem groups recorded.

```{r}
ggplot(dat, aes(x = hovedøkosystem))+
  geom_bar()+
  coord_flip()
```

This project is concerned only with wetlands (våtmark), semi-natural areas (semi-naturlig mark) and naturally open areas below the forest line (naturlig åpne områder i lavlandet/under skoggrensa).

```{r}
dat$hovedøkosystem[dat$hovedøkosystem == "Naturlig åpne områder i lavlandet"] <- "Naturlig åpne områder under skoggrensa"
```

```{r}
unique(dat$hovedøkosystem)
utvlagt <- c("Semi-naturlig mark",
             "Våtmark",
             "Naturlig åpne områder under skoggrensa")
dat2 <- dat[dat$hovedøkosystem %in% utvlagt,]
```

```{r}
temp <- tapply(dat2$area, dat2$hovedøkosystem, sum)
temp <- data.frame(eco = row.names(temp),
                   area = temp)
ggplot(temp, aes(x = eco, y=area))+
  geom_bar(stat="identity")+
  coord_flip()
```

The same bias towards sami-natural areas are seen when looking at the area mapped, as when looking the number of polygons.

-   What are the dominant nature types recorded.

```{r}


temp <- dat2[dat2$hovedøkosystem=="Våtmark",]

temp <- tapply(temp$area, temp$naturtype, sum)
temp <- data.frame(nat = row.names(temp),
                   area = temp)

ggplot(temp[order(temp$area),], 
       aes(x = nat,
           y = area))+
  geom_bar(stat = "identity")+
  coord_flip()
```

-   Can we group these into main ecosystem type categories?
-   Are there any regional differences

## Environmental space

-   Extract environmental data from the polygons and compare against reference data points.
-   Uni-variate (e.g. *boreal hei* plotted against elevation, oceanity, distance from roads, etc)

## Represntaivity in mapping units

Only a subset of nature types are mapped. How well do the mapped units represent, or cover, the range of nature types that is included for each main ecosystem group?

## Conclution 1

Conclude about which main ecosystem types that can reliably assess using the available mapping units?

What about suitability for defining reference values?

## Suitability

In the subset of mapping units that can be said to represent an ecosystem group, which NiN or MdirPRAM variables should we use?

## Concrete examples

### Andel lynghei med minst to faser i kystlynghei

### Areal uten skadet og/eller død røsslyng i kystlynghei

### Aktuell bruksintensitet
