# On the application of the naturetype dataset - Part 2 - Representativity {#naturtype2}

<br />

*Work in progress*

```{r, include=FALSE}
library(knitr)
library(sf)
library(tmap)
library(ggplot2)
library(data.table)
library(stringr)
library(units)
library(dplyr)
library(RColorBrewer)
library(forcats)
library(tidyr)
knitr::opts_chunk$set(echo = TRUE)
```

Author: Anders L. Kolstad

Date: `r Sys.Date()`

This chapter continues with the cleaned dataset exported at the end of the previous chapter:
```{r, eval=T}
dat <- readRDS("/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/Mdir_Naturtyper_cleanedALK.rds")
```

## Naturetypes, condition variables, and their linkage to NiN main types
Only a subset of nature types are mapped. How well do these mapped units/areas represent the range of nature types that is included for each main ecosystem group? And what condition variables do we have available for each of these?

### Nature types
Lets extract the unique nature types, their associated main ecosystem, and the year when these nature types were mapped. 

We will only include our target ecosystems, and we will exclude *Hule eiker*.
```{r}
target <- c("Semi-naturlig mark",
            "Våtmark",
            "Naturlig åpne områder under skoggrensa")
dat <- dat[dat$hovedøkosystem %in% target,]
dat <- dat[dat$naturtype != "Hule eiker",]
```

Get the unique nature types
```{r}
ntyp <- unique(dat$naturtype)
```

Extract the year when these were mapped
```{r}
years <- NULL
for(i in 1:length(ntyp)){
years[i] <- paste(sort(unique(dat$kartleggingsår[dat$naturtype == ntyp[i]])), collapse = ", ")
}
```

Extract the associated ecosystem
```{r}
eco <- NULL
for(i in 1:length(ntyp)){
eco[i] <- paste(unique(dat$hovedøkosystem[dat$naturtype == ntyp[i]]), collapse = ", ")
}
```

Combine into one data frame
```{r}
ntypDF <- data.frame(
  "Nature_type" = ntyp,
  "Year"        = years,
  "Ecosystem"   = eco
)
```

We have 66 nature types to consider. Some of the wetland types can actually be excluded because of the way we limited this ecosystem to mean *Open Wetland*.

```{r}
excl_nt <- c("Kalkrik myr- og sumpskogsmark",
             #"Flommyr, myrkant og myrskogsmark",  # Only V9 is relevant. This type also includes V2 and V8
             "Gammel fattig sumpskog",
             "Rik gransumpskog",
             "Grankildeskog",
             "Rik svartorsumpskog",
             "Rik gråorsumpskog",
             "Rik svartorstrandskog",
             "Saltpåvirket svartorstrandskog",
             "Kilde-edellauvskog",
             "Saltpåvirket strand- og sumpskogsmark",
             "Svak kilde og kildeskogsmark",
             "Rik vierstrandskog",
             "Varmekjær kildelauvskog"
             )
`%!in%` <- Negate(`%in%`)
ntypDF <- ntypDF[ntypDF$Nature_type %!in% excl_nt,]
```

```{r, fig.cap="List of nature types showing the years when that nature type was mapped." }
DT::datatable(ntypDF)
```

The way to do this I think is to look at each nature type in turn and map the NiN main types and sub-types that they cover. At the same time I can extract the NiN variables and values to see.


### NiN variables

```{r}
#Exclude non-relevant types
dat2 <- dat[dat$naturtype %!in% excl_nt,]

# Melt
dat2L <- tidyr::separate_rows(dat2, ninbeskrivelsesvariabler, sep=",")

# Split the code and the value into separate columns
dat2L <- tidyr::separate(dat2L, 
                              col = ninbeskrivelsesvariabler,
                              into = c("NiN_variable_code", "NiN_variable_value"),
                              sep = "_",
                              remove=F
                              )
# One NA produced here, but I check it, and it's fine.

# Convert values to numeric. This causes some NA's which I will go though below
dat2L$NiN_variable_value <- as.numeric(dat2L$NiN_variable_value)

```

Here are all the Nin variable codes:
```{r}
unique(sort(dat2L$NiN_variable_code))
```

Converting NiN_variable_value to numeric also introduced NA's for these categories: 
```{r}
sort(unique(dat2L$NiN_variable_code[is.na(dat2L$NiN_variable_value)]))
```
When I now go through the variable codes separately I will also judge if these NA's are real, or if they for example should be coded as zeros or something.

#### 1AG-A (sjiktdekningsvariabler)
These are different variables describing the cover in different vegetation strata and/or species

* 1AG-A-0 = Total tre canopy cover
* 1AG-B = Total shrub cover
* 1AG-C = Total field layer cover
* 1AG-A-E = 'Overstandere'
* 1AG-A-G = 'gjenveksttrær'


#### 1AR-C-L (Andel vedvekster i fletsjiktet)
A condition variable in some mire nature types

#### 3TO (Torvmarksformer)
These are defining variables, and not part of the condition assessment.
```{r}
exclude <- c("3TO-BØ",
             "3TO-HA",
             "3TO-HE",
             "3TO-HK",
             "3TO-HN",
             "3TO-HP",
             "3TO-PA",
             "3TO-TE")
```


#### 4DL (Coarse dead wood)
4DL-SS-0 and 4DL-S-0 has to do with the total amount of coarse woody debris/logs. It was only recorded for one nature type in 2018, and then as a a biodiversity variable, and not a state variable. Biodiversity variables were only recorded when condition was better than *very poor*. This bias means we cannot use these variables.

```{r}
exclude <- c(exclude,
             "4DL-SS-0",
             "4DL-S-0")
```


#### 4TG (old trees)

These three variables are used as biodiveristy variables in  2018 (exclude).
```{r}
exclude <- c(exclude,
             "4TG-BL",
             "4TG-EL",
             "4TG-GF")
```


#### 4TL (trees with fire scars)
These five variables are ised together with 4TG as biodiversity variables in 2018.
```{r}
exclude <- c(exclude,
             "4TL-BS",
             "4TL-HE",
             "4TL-HL",
             "4TL-RB",
             "4TL-SB")
```

#### 5AB and 5BY
These area land use types (arealbruksklasser) and building types, respectively, and the values are not numeric, but categorical, and represents presence or absence of these land uses or objects. These are not suited for automatically determining ecosystem condition as this is done subjectively in the field.
```{r}
exclude <- c(exclude,
             "5AB-0",
             "5AB-DO-TT",
             "5BY-0"
             )
```

#### 6SE and 6SO (Bioclimatical sections and sones)
Not relevant here as a condition variable.
```{r}
exclude <- c(exclude,
             "6SE",
             "6SO")
```

#### 7FA (fremmedartsinnslag)
Should not have been allowed the value X, so Ok to exclude these.

#### 7GR-GI
7GR-GI (grøftingsintensitet) should not have the value X either, so OK to exclude these.

#### 7JB-KU (Kystlyngheias utviklingsfaser)

* BY = byggefase
* DE = degenereringsfase
* MO = moden fase
* PI = pionerfase

This variable is used as in the biodiversity assessment, and can therefore not be used in the condition assessment because localities with *very poor* conditions have not been mapped/assessed.
```{r}
exclude <- c(exclude, 
             "7JB-KU-BY", 
             "7JB-KU-DE", 
             "7JB-KU-MO", 
             "7JB-KU-PI")
```

I will nonetheless explore this variable a bit more.
NiN defines the possible values for these as numeric between 0 and 4 (shifted to become 1-5 in the dataset), but there are 544 cases where it has been given then value *X*.
```{r}
temp <- dat2L[dat2L$ninbeskrivelsesvariabler == "7JB-KU-BY_X" |
                     dat2L$ninbeskrivelsesvariabler == "7JB-KU-DE_X" |
                dat2L$ninbeskrivelsesvariabler == "7JB-KU-MO_X" |
                     dat2L$ninbeskrivelsesvariabler == "7JB-KU-PI_X",]
table(temp$kartleggingsår, temp$naturtype)
```

The reason could be that this variable is used in the biodiversity assessment, which is not performed if the condition is *very poor*.
```{r}
table(temp$tilstand)
```
That is not the case. If the condition is scored as low, the variable does not even appear in the data set for that locality.

We can also make a note that a big proportion of the total number of localities of *Kystlynghei* had very poor condition, and therefore this variable 7JB-KU was not recorded.
```{r, fig.cap="The distribution of condition scores for Kystlynghei."}
KU <- dat2[dat2$naturtype=="Kystlynghei",]
barplot(table(KU$tilstand))
```

Each *kystlynghei* locality should have values for all four parameters (7BA-BY/DE/MO/PI), but if we look at some cases in more detail, to understand why some of these values have been set as X (probably means they were left blank), for example like this:
```{r}
#View(dat2L[dat2L$NiN_variable_code == "7JB-KU-BY" & is.na(dat2L$NiN_variable_value),])
#View(dat2L[dat2L$identifikasjon_lokalid =="NINFP1810002975",]) # None of the 7JB-KU variables have values
#View(dat2L[dat2L$identifikasjon_lokalid =="NINFP2110057689",]) # Two of the 7JB-KU variables have values
```
 ... we can see that sometimes <4 but >0 of the variables/phases has been given a score, but sometimes none have. This makes it problematic to set these NA's to be zeros. When we also consider the fact that there is an obvious bias in that only localities with poor condition or better have these variables assessed in the first place, I will exclude all of these variables and treat them as *not suited*.

#### 7JB-BA = Aktuell bruksintensitet
A common condition variable in semi-natural nature types. It's a borderline pressure indicator, but I will keep it in the data set for now at least.

Overview of cases where the value is set as *X*.
```{r}
temp <- dat2L[dat2L$ninbeskrivelsesvariabler == "7JB-BA_X",]
table(temp$kartleggingsår, temp$naturtype)
```
These are just a few cases, mostly from 2018. OK to treat as NA.

#### 7JB-BT = Beitetrykk
Similar variable to the above.
```{r}
temp <- dat2L[dat2L$ninbeskrivelsesvariabler == "7JB-BT_X",]
table(temp$kartleggingsår, temp$naturtype)
```
OK to treat X's as NA's.

#### 7JB-GJ = Gjødsling
Similar variable to the two above.
```{r}
temp <- dat2L[dat2L$ninbeskrivelsesvariabler == "7JB-BT_X",]
table(temp$kartleggingsår, temp$naturtype)
```
OK to treat as X's NA's.

#### 7JB-HT (Høsting av tresjiktet)
Used for *Lauveng*in 2019 and 2020.
```{r}
temp <- dat2L[dat2L$NiN_variable_code == "7JB-HT-ST" | 
               dat2L$NiN_variable_code == "7JB-HT-SL" ,]
table(temp$kartleggingsår, temp$naturtype)
```
This is so marginal that I will exclude then already now.
```{r}
exclude <- c(exclude,
             "7JB-HT-SL",
             "7JB-HT-ST")
```

#### 7RA-BH and 7RA-SJ (rask suksesjon i boreal hei og i i semi-naturlig og sterkt endret jordbruksmark inkludert våteng)
Condition variables.
There are some very few cases where 7RA-SJ has the value X. It should be numeric 1-4, so the value X is a mistake here I think. We can exclude these (i.e. allow them to be NA's).

#### 7SD
7SD-NS and 7SD-0 was also only used for one nature type, and then only for wooded localities of *Flommyr, myrkant og myrskogsmark*. *X* therefore means *not relevant*, and we can also exclude the parameters from the dataset all together.

```{r}
exclude <- c(exclude, 
             "7SD-0",     
             "7SD-NS")
```

#### 7TK and /SE
7TK (kjørespor) and 7SE (slitasje) are not allowed the value X, but it happened on some rare occasions (24) anyhow. It's fine to treat these as NA's.

#### 7VR-RI
*Reguleringsintensitet*
This variable is defined as numeric between 1-5. There is, however, quite a few cases where it is X.
```{r}
temp <- dat2L[dat2L$ninbeskrivelsesvariabler == "7VR-RI_X",]
table(temp$kartleggingsår, temp$naturtype)
```
I cannot explain these, but in any case, this variable is not a good indicator for condition as it rather represents a pressure/driver. So OK to treat as NA's.

#### LKMs and MdirPR-variables
These variables include LKM's (lokal kompleks miljøvariabel) which are nonrelevant to us here. We can also exclude some of the PR- variables, which are the NEAs own variables (not NiN). 

* LKMKI
    + Kalk (lime)
    + Exclude
* LKMSP
    + Slåttemarkspreg
    + Exclude
* PRAK
    + Antall NiN-kartleggingsenheter
    + Used in the biodiversity assessment
    + Exclude
* PRAM
    + Menneskeskapte objekter
    + Related to 5BY and 5AB
    + Exclude (se 5BY and 5AB)
* PRH
    + This is perhaps a mistake and should be PRHA or PRHT
    + Exclude
* PRHA
    + Habitat spesifikke arter
    + Used in the biodiversity assessment
    + Exclude
* PRHT
    + Høsting av tresjiktet
    + Include
* PRKA
    + Kalkindikatorer
    + Used in the biodiversity assessment
    + Exclude
* PRKU
    + Kystlyngheias utviklingsfaser
    + Related to 7JB-KU
    + Used in the biodiversity assessment
    + Exclude
* PRMY
    + Myrstruktur
    + Used in the biodiversity assessment
    + Exclude
* PRRL-CR/DD/EN/NT/VU
    + Red list categories
    + Used in the biodiversity assessment
    + Exclude
* PRSE-KA
    + Strukturer, elementer og torvmarksformer (in 2018)
    + See PRSE-PA
* PRSE-PA
    + Strukturer, elementer og torvmarksformer
    + Used in the biodiversity assessment
    + Exclude
* PRSE-SH
    + Strukturer, elementer og torvmarksformer (in 2018)
    + See PRSE-PA
* PRSL
    + Slitasje
    + Rlated to 7SE
    + Include
* PRTK
    + Spor av tunge kjøretøyer
    + Related to 7TK
    + Include
* PRTO
    + Torvuttak
    + Include
* PRVS
    + Variasjon i vannsprutintensitet
    + Used in the biodiversity assessment
    + Exclude

```{r}
exclude <- c(exclude,
             "LKMKI",     
          "LKMSP",
          "PRAK",
          "PRAM",
          "PRH",
          "PRHA",
          "PRKA",
          "PRKU",
          "PRMY",
          "PRRL-DD",   "PRRL-VU",   "PRRL-NT",   "PRRL-EN",   "PRRL-CR",  
          "PRSE-KA",
          "PRSE-PA",
          "PRSE-SH",
          "PRVS"
          )
```


### Subset
```{r}
dat2L2 <- dat2L[!is.na(dat2L$NiN_variable_value),]
dat2L2 <- dat2L2[dat2L2$NiN_variable_code %!in% exclude,]
length(unique(dat2L2$NiN_variable_code))
```
Now we are down to 20 possible condition variables.

I will also now exclude nature types that were only mapped in 2018 and/or and not after that. These nature types will not only not get more data in the future, but also they were mapped in a time when the methodology was quite unstable. 

```{r}
ntypDF2 <- ntypDF[ntypDF$Year != "2018" &
                  ntypDF$Year != "2019" & 
                  ntypDF$Year != "2018, 2019"# no types were mappend in 2018 & 2019 only
                  ,]
```

### Fill inn ntypDF2 
Next I want to expand ntypDF2 to include the NiN main types covered by the different nature types. I cannot use the field data for this, because there are so many mistakes in the data. I need to look at the definition of each nature type and get the NiN code from there. I could also extract the NiN sub types (grunntyper), but it would become too messy. 

I will look at the definitions of the nature type in the first and last year when that type was mapped, but not for the years in between.

#### Add NiN main type and degree of representativity
```{r}
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Aktiv skredmark"                                    ] <- "T17 | all (if including sub-types)"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Åpen flomfastmark"                                  ] <- "T18 | all"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Åpen grunnlendt kalkrik mark i boreonemoral sone"   ] <- "T2  | calcareous"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Åpen grunnlendt kalkrik mark i sørboreal sone"      ] <- "T2  | calcareous"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Atlantisk høymyr"                                   ] <- "V3  | all (if including sub-types)" # can also include smaller areas of V1
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Boreal hei"                                         ] <- "T31 | all"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Eksentrisk høymyr"                                  ] <- "V3  | all (if including sub-types)" # can also include smaller areas of V1
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Eng-aktig sterkt endret fastmark"                   ] <- "T41 | all"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Fosse-eng"                                          ] <- "T15 | all"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Fosseberg"                                          ] <- "T1  | extra wet"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Fossepåvirket berg"                                 ] <- "T1  | extra wet"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Fuglefjell-eng og fugletopp"                        ] <- "T8  | all"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Hagemark"                                           ] <- "T32 | special management"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Høgereligende og nordlig nedbørsmyr"                ] <- "V3  | all (if including sub-types)" # torvmarksformene are excluded
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Isinnfrysingsmark"                                  ] <- "T20 | all"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Kalkrik helofyttsump"                               ] <- "L4 | calcareous"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Kanthøymyr"                                         ] <- "V3  | all (if including sub-types)" # can also include smaller areas of V1
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Konsentrisk høymyr"                                 ] <- "V3  | all (if including sub-types)" # can also include smaller areas of V1
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Kystlynghei"                                        ] <- "T34 | all"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Lauveng"                                            ] <- "T32 | special management"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Nakent tørkeutsatt kalkberg"                        ] <- "T1  | calcareous and dry"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Naturbeitemark"                                     ] <- "T32 | special management"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Øvre sandstrand uten pionervegetasjon"              ] <- "T29 | sandy and vegetated"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Øyblandingsmyr"                                     ] <- "V1  | partial" # also includes V3
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Palsmyr"                                            ] <- "V3  | all (if including sub-types)"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Platåhøymyr"                                        ] <- "V3  | all (if including sub-types)" # can also include smaller areas of V1
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Rik åpen jordvannsmyr i mellomboreal sone"          ] <- "V1  | calcareous"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Rik åpen jordvannsmyr i nordboreal og lavalpin sone"] <- "V1  | calcareous"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Rik åpen sørlig jordvannsmyr"                       ] <- "V1  | calcareous"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Sanddynemark"                                       ] <- "T21 | all (if including sub-types)"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Semi-naturlig eng"                                  ] <- "T32 | all (if including sub-types)"
# This might be called Kulturmarkseng in the 2018 protocol, but Semi-naturlig eng in the data set. 
# Kulturmarkseng also includes V10
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Semi-naturlig myr"                                  ] <- "V9  | all (if including sub-types)"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Semi-naturlig strandeng"                            ] <- "T33 | all (-2018)" # could perhaps be used in 2018, but it's defined awkwardly
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Semi-naturlig våteng"                               ] <- "V10 | all (-2018)"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Silt og leirskred"                                  ] <- "T17 | all (if including sub-types)"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Slåttemark"                                         ] <- "T32 | special management"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Slåttemyr"                                          ] <- "V9  | all (if including sub-types)"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Sørlig etablert sanddynemark"                       ] <- "T21 | all (if including sub-types)"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Sørlig kaldkilde"                                   ] <- "V4  | southern"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Sørlig nedbørsmyr"                                  ] <- "V3  | all (if including sub-types)"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Sørlig slåttemyr"                                   ] <- "V9  | all (if including sub-types)"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Strandeng"                                          ] <- "T12 | all (-2018)"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Svært tørkeutsatt sørlig kalkberg"                  ] <- "T1  | calcareous and dry"
ntypDF2$hovedgruppe[ntypDF2$Nature_type == "Terrengdekkende myr"                                ] <- "V3  | all (if including sub-types)"

```

Split this new column in two.
```{r}
ntypDF2 <- ntypDF2 %>%
  tidyr::separate(col = hovedgruppe,
                  into = c("NiN_mainType", "NiN_mainTypeCoverage"),
                  #sep = "|",
                  remove=T,
                  extra = "merge"
              )
```

#### Add NiN variables

```{r}
ntyp_vars <- as.data.frame(table(dat2L2$naturtype, dat2L2$NiN_variable_code))
names(ntyp_vars) <- c("Nature_type", "NiN_variable_code", "NiN_variable_count")
(ntyp_vars <- ntyp_vars[ntyp_vars$NiN_variable_count >0,])
```

Add a column for the total nmber of localities for each nature type and get the percentage of localities where each NiN has been recorded.
```{r}
#options(scipen=999) # suppress exp notation
count <- as.data.frame(table(dat2$naturtype))
names(count) <- c("Nature_type", "totalLocations")
ntyp_vars$totalLocations <- count$totalLocations[match(ntyp_vars$Nature_type, count$Nature_type)]
ntyp_vars$percentageUse <- round((ntyp_vars$NiN_variable_count/ntyp_vars$totalLocations)*100, 1)
```

Cast to get NiN codes as columns
```{r}
ntyp_vars_wide <- data.table::dcast(setDT(ntyp_vars),
                                    Nature_type~NiN_variable_code,
                                    value.var = "percentageUse")
```

This dat set contains the nature types that were only mappen in 2018 or 2019, and which we removed from ntypDF2. 
```{r}
ntyp_vars_wide$Nature_type[ntyp_vars_wide$Nature_type %!in% ntypDF2$Nature_type]
```

So we should remove them also here.
```{r}
ntyp_vars_wide <- ntyp_vars_wide[ntyp_vars_wide$Nature_type %in% ntypDF2$Nature_type]
```

Combine datasets
```{r}
ntyp_fill <- cbind(ntypDF2, ntyp_vars_wide[,-1][match(ntypDF2$Nature_type, ntyp_vars_wide$Nature_type)])
```


#### Add number of location and total area mapped
```{r}
dat2$km2 <- units::drop_units(dat2$area/10^6)

num <- as.data.frame(dat2) %>%
  group_by(naturtype)%>%
  summarise(km2 = sum(km2),
            numberOfLocalities = n())

ntyp_fill <- cbind(ntyp_fill, num[,-1][match(ntyp_fill$Nature_type, num$naturtype),])
```

## Plots

```{r, fig.cap="The total mapped area for nature types associated with three selected main ecosystems"}

mySize <- 8
gg_area <- ntyp_fill %>%
  arrange(km2) %>%
  mutate(Nature_type=factor(Nature_type, levels=Nature_type)) %>%   # This trick update the factor levels
  ggplot( aes(x = Nature_type,
                   y = km2)) +
        geom_segment( aes(xend=Nature_type, yend=0)) +
        geom_point( size=4, aes(group = Ecosystem,
                                colour= Ecosystem)) +
        coord_flip() +
        theme_bw(base_size = mySize) +
        xlab("")+
        ylab(expression(km^2))+
      theme(legend.position = "top",
        legend.key.size =  unit(.05, 'cm'),
            legend.background = element_rect(fill = "white", color = "black")
            )

gg_locs <- ntyp_fill %>%
  arrange(km2) %>%
  mutate(Nature_type=factor(Nature_type, levels=Nature_type)) %>%    # also sorted after km2
  ggplot( aes(x = Nature_type,
                   y = numberOfLocalities)) +
        geom_segment( aes(xend=Nature_type, yend=0)) +
        geom_point( size=4, aes(group = Ecosystem,
                                colour= Ecosystem)) +
        coord_flip() +
        theme_bw(base_size = mySize) +
        xlab("")+
        ylab("Number of localities")+
  theme(legend.position = "none",
        axis.text.y = element_blank())


egg::ggarrange(gg_area, gg_locs, 
                        ncol = 2)

```



### Area per NiN main type conditioned on ecosystem and adding empty main types
First I will add the NiN main types that are not covered by any nature types.

```{r}
open <- c(
  "T1",
  "T2",
  "T6",
  "T8",
  "T11",
  "T12",
  "T13",
  "T15",
  "T16",
  "T17",
  "T18",
  "T20",
  "T21",
  "T23",
  "T24",
  "T25",
  "T26",
  "T27",
  "T29"
)

semi <- c(
  "T31",
  "T32",
  "T33",
  "T34",
  "T40",  # are these included
  "T41"   # are these included
)

wetland <- c(
  "V1",
  "V3",
  "V4",
  "V6",
  "V9",
  "V10",
  "L4"    # this will probably not be part of the assessments
  
)

```

Adding the non-mapped open types
```{r}
open[open %!in% ntyp_fill$NiN_mainType]
```

```{r}
ntyp_fill2 <- ntyp_fill %>%
  add_row(NiN_mainType = "T6", Ecosystem = "Naturlig åpne områder under skoggrensa", NiN_mainTypeCoverage = "Not mapped", km2 = 0) %>%
  add_row(NiN_mainType = "T11", Ecosystem = "Naturlig åpne områder under skoggrensa", NiN_mainTypeCoverage = "Not mapped", km2 = 0) %>%
  add_row(NiN_mainType = "T13", Ecosystem = "Naturlig åpne områder under skoggrensa", NiN_mainTypeCoverage = "Not mapped", km2 = 0) %>%
  add_row(NiN_mainType = "T16", Ecosystem = "Naturlig åpne områder under skoggrensa", NiN_mainTypeCoverage = "Not mapped", km2 = 0) %>%
  add_row(NiN_mainType = "T23", Ecosystem = "Naturlig åpne områder under skoggrensa", NiN_mainTypeCoverage = "Not mapped", km2 = 0) %>%
  add_row(NiN_mainType = "T24", Ecosystem = "Naturlig åpne områder under skoggrensa", NiN_mainTypeCoverage = "Not mapped", km2 = 0) %>%
  add_row(NiN_mainType = "T25", Ecosystem = "Naturlig åpne områder under skoggrensa", NiN_mainTypeCoverage = "Not mapped", km2 = 0) %>%
  add_row(NiN_mainType = "T26", Ecosystem = "Naturlig åpne områder under skoggrensa", NiN_mainTypeCoverage = "Not mapped", km2 = 0) %>%
  add_row(NiN_mainType = "T27", Ecosystem = "Naturlig åpne områder under skoggrensa", NiN_mainTypeCoverage = "Not mapped", km2 = 0) 

```


Adding the non-mapped semi-natural types
```{r}
semi[semi %!in% ntyp_fill$NiN_mainType]
```
```{r}
ntyp_fill2 <- ntyp_fill %>%
  add_row(NiN_mainType = "T40", Ecosystem = "Semi-naturlig mark", NiN_mainTypeCoverage = "Not mapped", km2 = 0)
```

Adding the non-mapped wetland types
```{r}
wetland[wetland %!in% ntyp_fill$NiN_mainType]
```
This is Våtsnøleie, and my guess is that it IS mapped, but grouped with the aloine ecosystem. I'll therefore not add it in here, but mention it in the figure caption below.


```{r, fig.cap="The areas mapped for each NiN main type, and the degree of spatial representativity (or coverage) of the mapping units (nature types). V6 Våtsnøleie og snøleiekilde is not included."}
mySize <- 10
ntyp_fill2 %>%
  # combining two classes to get a better colour palette
  mutate(NiN_mainTypeCoverage = 
           replace(NiN_mainTypeCoverage, NiN_mainTypeCoverage == "southern", "partial"),
         NiN_mainTypeCoverage = 
           replace(NiN_mainTypeCoverage, NiN_mainTypeCoverage == "calcareous and dry", "calcareous")) %>%
  
  group_by(NiN_mainType, NiN_mainTypeCoverage) %>%
  mutate(km2 = sum(km2)) %>%
  slice_head()%>%
  select(Ecosystem,
         NiN_mainType,
         NiN_mainTypeCoverage,
         km2)%>%
  ungroup() %>%
  mutate(NiN_mainType = fct_reorder(NiN_mainType, km2)) %>%
  ggplot(aes(x = NiN_mainType,
             y = km2,
             fill = NiN_mainTypeCoverage))+
    geom_bar(stat = "identity",
             colour = "grey40",
             position = "stack")+
    theme_bw(base_size = mySize)+
    coord_flip()+
  labs(x = "NiN main type",
       y = expression(km^2),
       fill = "Spatial coverage")+
  scale_fill_brewer(palette = "Set1")+
  facet_wrap(vars(Ecosystem),
             scales = "free",
             labeller = label_wrap_gen(width=25))
  
```


### For each NiN main type, the proportion mapped with each NiN variable


### For each ecosystem, the proportion mapped with each NiN variable
















Next, are the coverage of NiN main types representative of the Hovedøkosystem? Then I need to manually enter the NiN main types associated with each Hovedøkosystem and perhaps add them as blank rows in ntypDF2.

Candidate nature types or groups of nature types that may be suitable to describe ecosystem condition for a NiN main type or Hovedøkosystem will be subject to further testing to look for environmental bias.


```{r}
ntypDF$coverage[ntypDF$Nature_type == "Slåttemark"] <- "Partial"
```

```{r}
codes <- unique(dat2L2$NiN_variable_code)
```

Next, add 'codes' in seperate rows (wide) and cast to columns

-------------------------



```{r}
wet_1_long2 <- wet_1_long[!is.na(wet_1_long$NiN_variable_value),]
```


This leaves us with the following parameters.
```{r}
unique(wet_1_long2$NiN_variable_code)
```
We can probably exclude several of these as non-relevant.


1AG-B is the total shrub cover
7TK is *kjøreskade*
1AG-A-G is *dekning gjenveksttrær*






```{r}
ntyp <- unique(wet_1_long$naturtype)
```

```{r}

temp <- wet_1_long[wet_1_long$naturtype == ntyp[1],]
table(temp$naturtype)

ggplot(temp)+
  geom_histogram(aes(x = NiN_variable_value))+
  facet_wrap(vars(NiN_variable_code))
```



------------------------------------------


### Våtmark
I will start by looking at wetlands (våtmark).

```{r}
wet <- myData[myData$hovedøkosystem == "Våtmark",]
any(wet[wet$naturtype == " Hule eiker",])
```

How many mosaic localities do we have?
```{r}
wet_Mos <- wet[wet$mosaikk == "Ja",]
nrow(wet_Mos)
```
275, compared to 
```{r}
wet_noMos <- wet[wet$mosaikk != "Ja",]
nrow(wet_noMos)
```
118550 *normal* localities.

Let's plot the summed area of each NiN main type, excluding mosaic localities.
```{r, fig.cap="Total mapped are for each NiN main type in the wetland ecosystem (excluding mosaics)"}
temp <- stats::aggregate(data = wet_noMos,
                                 area~ninkartleggingsenheter3, FUN = sum)

names(temp)[2] <- "area_m2"
temp$area_km2 <- drop_units(temp$area_m2/10^6)


ggplot(temp,
       aes(x = ninkartleggingsenheter3,
               y = area_km2))+
  geom_bar(
           fill="grey",
           colour="black",
           stat="identity")+
  coord_flip()+
  theme_bw(base_size = 12)+
  labs(y = "Total mapped area (km/2)",
       x = "NiN main types")
```

If we include mosaic localities we get some other main types included as well
```{r, fig.cap="Total mapped are for each NiN main type in the wetland ecosystem (including mosaics)"}
wet_long <- tidyr::separate_rows(wet, ninkartleggingsenheter3)
wet_long_agg <- stats::aggregate(data = wet_long,
                                 area~ninkartleggingsenheter3, FUN = sum)
names(wet_long_agg)[2] <- "area_m2"
wet_long_agg$area_km2 <- drop_units(wet_long_agg$area_m2/10^6)
ggplot(wet_long_agg,
       aes(x = ninkartleggingsenheter3,
               y = area_km2))+
  geom_bar(
           fill="grey",
           colour="black",
           stat="identity")+
  coord_flip()+
  theme_bw(base_size = 12)+
  labs(y = "Total mapped area (km/2)",
       x = "NiN main types")
```

Especially T34 (kystlynghei) and T1 (nakent berg) commonly occur in mosaics with wetlands.

V5, V6 are V7 are not represented at all. V5 is *Varm kilde* which we don't have in mainland Norway. V6 and V7 might be linked to the alpine ecosystem.






### Kalkrik myr- og sumpskogsmark
Only mapped in 2018. Back then, the defining NiN variables were not clearly stated, but the defining text clearly show that this is forested land, and so it should not be included in our assessment since our operational definition of Våtmark is *Åpen våtmark / open wetlands*.

```{r}
ntypDF$Eligible[ntypDF$Nature_type == "Kalkrik myr- og sumpskogsmark"] <- "No"
```



### Slåttemyr
Mapped in all years and covers the entire NiN space in V9. 
```{r}
ntypDF$Eligible[ntypDF$Nature_type == "Slåttemyr"] <- "Yes"
ntypDF$NiN_mainType[ntypDF$Nature_type == "Slåttemyr"] <- "V9"
ntypDF$NiN_mainType_coverage[ntypDF$Nature_type == "Slåttemyr"] <- "Complete"

ntypDF$'Busksjikt-dekning (1AG-B)'[ntypDF$Nature_type == "Slåttemyr"] <- "Recorded in all years."
ntypDF$'Grøftings-intensitet (7GR-GI)'[ntypDF$Nature_type == "Slåttemyr"] <- "Recorded in all years."
ntypDF$'Dekning av gjenvekst-trær (1AG-A-G)'[ntypDF$Nature_type == "Slåttemyr"] <- "Recorded in all years."
ntypDF$'Andel av vedvekster i feltsjiktet (1AR-C-L)'[ntypDF$Nature_type == "Slåttemyr"] <- "Recorded in all years."


ntypDF$Remarks[ntypDF$Nature_type == "Slåttemyr"] <- "The list of NiN condition variables has changed over the years, and possibly also the different threshold values."
```


## Environmental space

-   Extract environmental data from the polygons and compare against reference data points.
-   Uni-variate (e.g. *boreal hei* plotted against elevation, oceanity, distance from roads, etc)


## Conclution 1

Conclude about which main ecosystem types that can reliably assess using the available mapping units?

What about suitability for defining reference values?

## Suitability

In the subset of mapping units that can be said to represent an ecosystem group, which NiN or MdirPRAM variables should we use?

## Concrete examples

### Andel lynghei med minst to faser i kystlynghei

### Areal uten skadet og/eller død røsslyng i kystlynghei

### Aktuell bruksintensitet