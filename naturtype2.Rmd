# On the application of the naturetype dataset - Part 2 - Representativity {#naturtype2}

<br />

*Work in progress*

```{r, include=FALSE}
library(knitr)
library(sf)
library(tmap)
library(ggplot2)
library(data.table)
library(stringr)
library(units)
library(dplyr)
knitr::opts_chunk$set(echo = TRUE)
```

Author: Anders L. Kolstad

Date: `r Sys.Date()`

This chapter continues with the cleaned dataset exported at the end of the previous chapter:
```{r, eval=T}
dat <- readRDS("/data/P-Prosjekter/41201785_okologisk_tilstand_2022_2023/data/Mdir_Naturtyper_cleanedALK.rds")
```

## Naturetypes, condition variables, and their linkage to NiN main types
Only a subset of nature types are mapped. How well do these mapped units/areas represent the range of nature types that is included for each main ecosystem group? And what condition variables do we have available for each of these?

### Nature types
Lets extract the unique nature types, their associated main ecosystem, and the year when these nature types were mapped. 

We will only include our target ecosystems, and we will exclude *Hule eiker*.
```{r}
target <- c("Semi-naturlig mark",
            "Våtmark",
            "Naturlig åpne områder under skoggrensa")
dat <- dat[dat$hovedøkosystem %in% target,]
dat <- dat[dat$naturtype != "Hule eiker",]
```

Get the unique nature types
```{r}
ntyp <- unique(dat$naturtype)
```

Extract the year when these were mapped
```{r}
years <- NULL
for(i in 1:length(ntyp)){
years[i] <- paste(unique(dat$kartleggingsår[dat$naturtype == ntyp[i]]), collapse = ", ")
}
```

Extract the associated ecosystem
```{r}
eco <- NULL
for(i in 1:length(ntyp)){
eco[i] <- paste(unique(dat$hovedøkosystem[dat$naturtype == ntyp[i]]), collapse = ", ")
}
```

Combine into one data frame
```{r}
ntypDF <- data.frame(
  "Nature_type" = ntyp,
  "Year"        = years,
  "Ecosystem"   = eco
)
```

We have 67 nature types to consider. Some of the wetland types can actually be excluded because of the way we limited this ecosystem to mean *Open Wetland*.

```{r}
excl_nt <- c("Kalkrik myr- og sumpskogsmark",
             #"Flommyr, myrkant og myrskogsmark",  # Only V9 is relevant. This type also includes V2 and V8
             "Gammel fattig sumpskog",
             "Rik gransumpskog",
             "Grankildeskog",
             "Rik svartorsumpskog",
             "Rik gråorsumpskog",
             "Rik svartorstrandskog",
             "Saltpåvirket svartorstrandskog",
             "Kilde-edellauvskog",
             "Saltpåvirket strand- og sumpskogsmark",
             "Svak kilde og kildeskogsmark",
             "Rik vierstrandskog",
             "Varmekjær kildelauvskog"
             )
`%!in%` <- Negate(`%in%`)
ntypDF <- ntypDF[ntypDF$Nature_type %!in% excl_nt,]
```

```{r, fig.cap="List of nature types associated with the ecosystem Våtmark, showing the year when that nature type was mapped." }
DT::datatable(ntypDF)
```

The way to do this I think is to look at each nature type in turn and map the NiN main types and sub-types that they cover. At the same time I can extract the NiN variables and values to see.


### NiN variables

```{r}
dat2 <- dat[dat$naturtype %!in% excl,]

dat2L <- tidyr::separate_rows(dat2, ninbeskrivelsesvariabler, sep=",")
dat2L <- tidyr::separate(dat2L, 
                              col = ninbeskrivelsesvariabler,
                              into = c("NiN_variable_code", "NiN_variable_value"),
                              sep = "_",
                              remove=F
                              )
dat2L$NiN_variable_value <- as.numeric(dat2L$NiN_variable_value)

```

Checking some NA's produced
```{r}
#View(dat2L[280973,])
#View(dat2[dat2$identifikasjon_lokalid =="NINFP2110037887",])
```
No problem.

Here are all the Nin variable codes:
```{r}
unique(sort(dat2L$NiN_variable_code))
```

Converting NiN_variable_value to numeric also introduced NA's for these categories: 
```{r}
sort(unique(dat2L$NiN_variable_code[is.na(dat2L$NiN_variable_value)]))
```
When I now go through the variable codes sperately I will also judge if these NA's are real, or if they for example should be coded as zeros or something.

#### 1AG-A
"1AG-A-0"   "1AG-A-E"   "1AG-A-G"   "1AG-B"     "1AG-C"

#### 1AR-C-L

#### 3TO
"3TO-HA"    "3TO-HE"    "3TO-HK"    "3TO-HN"   "3TO-HP"    "3TO-PA"    "3TO-TE"


#### 4DL
4DL-SS-0 and 4DL-S-0 has to do with the total amount of coarse woody debris/logs. It was only recorded for one nature type in 2018, and then as a a biodiversity variable, and not a state variable. *X* therefore means *not relevant*. 

#### 4TG
"4TG-BL"    "4TG-EL"    "4TG-GF"

#### 4TL
"4TL-BS"    "4TL-HE"    "4TL-HL" "4TL-RB"    "4TL-SB"

#### 5AB and 5BY
These area land use types (arealbruksklasser) and building types, respectively, and the values are not numeric, but categorical, and represents presence or absence of these land uses or objects. These are not suited for automatically determining ecosystem condition as this is done subjectively in the field.
```{r}
exclude <- c(
             "5AB-0",
             "5AB-DO-TT",
             "5BY-0"
             )
```

#### 6SE

#### 6SO

#### 7FA (fremmedartsinnslag)
Should not have been allowed the value X, so Ok to exclude these.

#### 7GR-GI
7GR-GI (grøftingsintensitet) should not have the value X either, so OK to exclude these.

#### 7JB-KU
* KU = Kystlyngheias utviklingsfaser
    + BY = byggefase
    + DE = degenereringsfase
    + MO = moden fase
    + PI = pionerfase

Let's look at 7JB-KU first.    
NiN defines the possible values for these as numeric between 0 and 4 (shifted to become 1-5 in the dataset), but there are 544 cases where it has been given then value *X*.
```{r}
temp <- dat2L[dat2L$ninbeskrivelsesvariabler == "7JB-KU-BY_X" |
                     dat2L$ninbeskrivelsesvariabler == "7JB-KU-DE_X" |
                dat2L$ninbeskrivelsesvariabler == "7JB-KU-MO_X" |
                     dat2L$ninbeskrivelsesvariabler == "7JB-KU-PI_X",]
table(temp$kartleggingsår, temp$naturtype)
#View(dat2L[dat2L$identifikasjon_lokalid ==  "NINFP1810033954",])
```

The reason could be that this variable is used in the biodiversity assessment, which is not performed if the condition is *very poor*.
```{r}
table(temp$tilstand)
```
That is not the case. If the condition is scored as low, the variable does not even appear in the data set for that locality.
We can also make a note that a big proportion of the total number of localities of *Kystlynghei* had very poor condition, and therefore this variable 7JB-KU was not recorded.
```{r, fig.cap="The distribution of condition scores for Kystlynghei."}
KU <- dat2[dat2$naturtype=="Kystlynghei",]
barplot(table(KU$tilstand))
```

Each *kystlynghei* locality should have values for all four parameters (7BA-BY/DE/MO/PI), but if we look at some cases in more detail, to understand why some of these values have been set as X (probably means they were left blank), for example like this:
```{r}
#View(dat2L[dat2L$NiN_variable_code == "7JB-KU-BY" & is.na(dat2L$NiN_variable_value),])
#View(dat2L[dat2L$identifikasjon_lokalid =="NINFP1810002975",]) # None of the 7JB-KU variables have values
#View(dat2L[dat2L$identifikasjon_lokalid =="NINFP2110057689",]) # Two of the 7JB-KU variables have values
```
 ... we can see that sometimes <4 but >0 of the variables/phases has been given a score, but sometimes none have. This makes it problematic to set these NA's to be zeros. When we also consider the fact that there is an obvious bias in that only localities with poor condition or better have these variables assessed in the first place, I will exclude all of these variables and treat them as *not suited*.
 
```{r}
exclude <- c(exclude, 
             "7JB-KU-BY", 
             "7JB-KU-DE", 
             "7JB-KU-MO", 
             "7JB-KU-PI")
```


#### 7JB-BA = Aktuell bruksintensitet
```{r}
temp <- dat2L[dat2L$ninbeskrivelsesvariabler == "7JB-BA_X",]
table(temp$kartleggingsår, temp$naturtype)
```
These are just a few cases, mostly from 2018. OK to treat as NA.

#### 7JB-BT = Beitetrykk
```{r}
temp <- dat2L[dat2L$ninbeskrivelsesvariabler == "7JB-BT_X",]
table(temp$kartleggingsår, temp$naturtype)
```
OK to treat as NA's.

#### 7JB-GJ = Gjødsling
```{r}
temp <- dat2L[dat2L$ninbeskrivelsesvariabler == "7JB-BT_X",]
table(temp$kartleggingsår, temp$naturtype)
```
OK to treat as NA's. This one, and some of the previous ones as well, are more like pressure indicators than condition indicators, but I wont worry too much about that at this stage.

#### 7JB-HT
"7JB-HT-SL" "7JB-HT-ST"

#### 7RA-BH
"7RA-BH"

#### 7RA-SJ
*Rask gjenvekstsuksesjon i semi-naturlig og sterkt endret jordbruksmark inkludert våteng*
There are some very few cases where this variable has the value X. It should be numeric 1-4, so the value X is a mistake here I think. We can exclude these (i.e. allow them to be NA's).


#### 7SD
7SD-NS and 7SD-0 was also only used for one nature type, and then only for wooded localities of *Flommyr, myrkant og myrskogsmark*. *X* therefore means *not relevant*, and we can also exclude the parameters from the dataset all together.

```{r}
exclude <- c(exclude, 
             "7SD-0",     
             "7SD-NS")
```



#### 7TK and /SE
7TK (kjørespor) and 7SE (slitasje) are not allowed the value X, but it happened on some rare occasions (24) anyhow. It's fine to exclude these.

#### 7VR-RI
*Reguleringsintensitet*
This variable is defined as numeric between 1-5. There is, however, quite a few cases where it is X.
```{r}
temp <- dat2L[dat2L$ninbeskrivelsesvariabler == "7VR-RI_X",]
table(temp$kartleggingsår, temp$naturtype)
```

I cannot explain these, but in any case, this variable is not a good indicator for condition as it rather represents a pressure/driver. So OK to treat as NA's

#### LKMs and MdirPR-variables
These variables include LKM's (lokal kompleks miljøvariabel) which are nonrelevant to us here. We can also exclude some of the PR- variables, which are the NEAs own variables (not NiN). 

* LKMKI
    + Kalk (lime)
    + Exclude
* LKMSP
    + Slåttemarkspreg
    + Exclude
* PRAK
    + Antall NiN-kartleggingsenheter
    + Used in the biodiversity assessment
    + Exclude
* PRAM
    + Menneskeskapte objekter
    + Related to 5BY and 5AB
    + Exclude (se 5BY and 5AB)
* PRH
    + This is perhaps a mistake and should be PRHA or PRHT
    + Exclude
* PRHA
    + Habitat spesifikke arter
    + Used in the biodiversity assessment
    + Exclude
* PRHT
    + Høsting av tresjiktet
    + Include
* PRKA
    + Kalkindikatorer
    + Used in the biodiversity assessment
    + Exclude
* PRKU
    + Kystlyngheias utviklingsfaser
    + Related to 7JB-KU
    + Used in the biodiversity assessment
    + Exclude
* PRMY
    + Myrstruktur
    + Used in the biodiversity assessment
    + Exclude
* PRRL-CR/DD/EN/NT/VU
    + Red list categories
    + Used in the biodiversity assessment
    + Exclude
* PRSE-KA
    + Strukturer, elementer og torvmarksformer (in 2018)
    + See PRSE-PA
* PRSE-PA
    + Strukturer, elementer og torvmarksformer
    + Used in the biodiversity assessment
    + Exclude
* PRSE-SH
    + Strukturer, elementer og torvmarksformer (in 2018)
    + See PRSE-PA
* PRSL
    + Slitasje
    + Rlated to 7SE
    + Include
* PRTK
    + Spor av tunge kjøretøyer
    + Related to 7TK
    + Include
* PRTO
    + Torvuttak
    + Include
* PRVS
    + Variasjon i vannsprutintensitet
    + Used in the biodiversity assessment
    + Exclude

```{r}
exclude <- c("LKMKI",     
          "LKMSP",
          "PRAK",
          "PRAM",
          "PRH",
          "PRHA",
          "PRKA",
          "PRKU",
          "PRMY",
          "PRRL-DD",   "PRRL-VU",   "PRRL-NT",   "PRRL-EN",   "PRRL-CR",  
          "PRSE-KA",
          "PRSE-PA",
          "PRSE-SH",
          "PRVS"
          )
```


### Subset
```{r}
dat2L2 <- dat2L[!is.na(dat2L$NiN_variable_value),]
dat2L2 <- dat2L2[dat2L2$NiN_variable_code %!in% exclude,]
```



Are the nature types or groups of nature types representative of the main NiN types?
And, is the coverage of NiN main types representative of the Hovedøkosystem?
If so then check for environmental bias.
If OK to continue, then check for available NiN variables, especially reoccurring variables.


```{r}
ntypDF$hovedgruppe[ntypDF$Nature_type == "Slåttemark"] <- "T32"
```

```{r}
ntypDF$coverage[ntypDF$Nature_type == "Slåttemark"] <- "Partial"
```

```{r}
codes <- unique(dat2L2$NiN_variable_code)
```

Next, add 'codes' in seperate rows (wide) and cast to columns

-------------------------



```{r}
wet_1_long2 <- wet_1_long[!is.na(wet_1_long$NiN_variable_value),]
```


This leaves us with the following parameters.
```{r}
unique(wet_1_long2$NiN_variable_code)
```
We can probably exclude several of these as non-relevant.


1AG-B is the total shrub cover
7TK is *kjøreskade*
1AG-A-G is *dekning gjenveksttrær*






```{r}
ntyp <- unique(wet_1_long$naturtype)
```

```{r}

temp <- wet_1_long[wet_1_long$naturtype == ntyp[1],]
table(temp$naturtype)

ggplot(temp)+
  geom_histogram(aes(x = NiN_variable_value))+
  facet_wrap(vars(NiN_variable_code))
```



------------------------------------------


### Våtmark
I will start by looking at wetlands (våtmark).

```{r}
wet <- myData[myData$hovedøkosystem == "Våtmark",]
any(wet[wet$naturtype == " Hule eiker",])
```

How many mosaic localities do we have?
```{r}
wet_Mos <- wet[wet$mosaikk == "Ja",]
nrow(wet_Mos)
```
275, compared to 
```{r}
wet_noMos <- wet[wet$mosaikk != "Ja",]
nrow(wet_noMos)
```
118550 *normal* localities.

Let's plot the summed area of each NiN main type, excluding mosaic localities.
```{r, fig.cap="Total mapped are for each NiN main type in the wetland ecosystem (excluding mosaics)"}
temp <- stats::aggregate(data = wet_noMos,
                                 area~ninkartleggingsenheter3, FUN = sum)

names(temp)[2] <- "area_m2"
temp$area_km2 <- drop_units(temp$area_m2/10^6)


ggplot(temp,
       aes(x = ninkartleggingsenheter3,
               y = area_km2))+
  geom_bar(
           fill="grey",
           colour="black",
           stat="identity")+
  coord_flip()+
  theme_bw(base_size = 12)+
  labs(y = "Total mapped area (km/2)",
       x = "NiN main types")
```

If we include mosaic localities we get some other main types included as well
```{r, fig.cap="Total mapped are for each NiN main type in the wetland ecosystem (including mosaics)"}
wet_long <- tidyr::separate_rows(wet, ninkartleggingsenheter3)
wet_long_agg <- stats::aggregate(data = wet_long,
                                 area~ninkartleggingsenheter3, FUN = sum)
names(wet_long_agg)[2] <- "area_m2"
wet_long_agg$area_km2 <- drop_units(wet_long_agg$area_m2/10^6)
ggplot(wet_long_agg,
       aes(x = ninkartleggingsenheter3,
               y = area_km2))+
  geom_bar(
           fill="grey",
           colour="black",
           stat="identity")+
  coord_flip()+
  theme_bw(base_size = 12)+
  labs(y = "Total mapped area (km/2)",
       x = "NiN main types")
```

Especially T34 (kystlynghei) and T1 (nakent berg) commonly occur in mosaics with wetlands.

V5, V6 are V7 are not represented at all. V5 is *Varm kilde* which we don't have in mainland Norway. V6 and V7 might be linked to the alpine ecosystem.






### Kalkrik myr- og sumpskogsmark
Only mapped in 2018. Back then, the defining NiN variables were not clearly stated, but the defining text clearly show that this is forested land, and so it should not be included in our assessment since our operational definition of Våtmark is *Åpen våtmark / open wetlands*.

```{r}
ntypDF$Eligible[ntypDF$Nature_type == "Kalkrik myr- og sumpskogsmark"] <- "No"
```



### Slåttemyr
Mapped in all years and covers the entire NiN space in V9. 
```{r}
ntypDF$Eligible[ntypDF$Nature_type == "Slåttemyr"] <- "Yes"
ntypDF$NiN_mainType[ntypDF$Nature_type == "Slåttemyr"] <- "V9"
ntypDF$NiN_mainType_coverage[ntypDF$Nature_type == "Slåttemyr"] <- "Complete"

ntypDF$'Busksjikt-dekning (1AG-B)'[ntypDF$Nature_type == "Slåttemyr"] <- "Recorded in all years."
ntypDF$'Grøftings-intensitet (7GR-GI)'[ntypDF$Nature_type == "Slåttemyr"] <- "Recorded in all years."
ntypDF$'Dekning av gjenvekst-trær (1AG-A-G)'[ntypDF$Nature_type == "Slåttemyr"] <- "Recorded in all years."
ntypDF$'Andel av vedvekster i feltsjiktet (1AR-C-L)'[ntypDF$Nature_type == "Slåttemyr"] <- "Recorded in all years."


ntypDF$Remarks[ntypDF$Nature_type == "Slåttemyr"] <- "The list of NiN condition variables has changed over the years, and possibly also the different threshold values."
```


## Environmental space

-   Extract environmental data from the polygons and compare against reference data points.
-   Uni-variate (e.g. *boreal hei* plotted against elevation, oceanity, distance from roads, etc)


## Conclution 1

Conclude about which main ecosystem types that can reliably assess using the available mapping units?

What about suitability for defining reference values?

## Suitability

In the subset of mapping units that can be said to represent an ecosystem group, which NiN or MdirPRAM variables should we use?

## Concrete examples

### Andel lynghei med minst to faser i kystlynghei

### Areal uten skadet og/eller død røsslyng i kystlynghei

### Aktuell bruksintensitet